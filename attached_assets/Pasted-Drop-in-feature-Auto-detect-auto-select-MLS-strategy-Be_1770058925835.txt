Drop-in feature: Auto-detect + auto-select MLS strategy

Below is a clean patch you can insert into moltid_init.sh Step 2.

1) Add these env vars at the top (config)
# Defaults you can set in your repo README / env
P2P_PORT="${P2P_PORT:-9001}"

# Your project-run community MLS (p2pidentity string). Leave blank if none.
COMMUNITY_MLS_HOST="${COMMUNITY_MLS_HOST:-}"

# Detection behavior
AUTO_DETECT_MLS="${AUTO_DETECT_MLS:-true}"        # true|false
PREFER_SOVEREIGN_MLS="${PREFER_SOVEREIGN_MLS:-true}" # true|false (marketing posture)

2) Add helper functions (once)
is_private_ip() {
  local ip="$1"
  [[ "$ip" =~ ^10\. ]] && return 0
  [[ "$ip" =~ ^127\. ]] && return 0
  [[ "$ip" =~ ^192\.168\. ]] && return 0
  # 172.16.0.0 – 172.31.255.255
  if [[ "$ip" =~ ^172\.([0-9]+)\. ]]; then
    local b="${BASH_REMATCH[1]}"
    (( b >= 16 && b <= 31 )) && return 0
  fi
  return 1
}

extract_ip_from_p2pidentity() {
  # p2pidentity looks like: Mx....@A.B.C.D:9001
  local ident="$1"
  echo "$ident" | sed -nE 's/.*@([^:]+):([0-9]+).*/\1/p'
}

extract_port_from_p2pidentity() {
  local ident="$1"
  echo "$ident" | sed -nE 's/.*@([^:]+):([0-9]+).*/\2/p'
}

is_listening_on_port() {
  local port="$1"
  if command -v ss >/dev/null 2>&1; then
    ss -ltn 2>/dev/null | grep -qE ":$port\s"
    return $?
  elif command -v netstat >/dev/null 2>&1; then
    netstat -ltn 2>/dev/null | grep -qE ":$port\s"
    return $?
  else
    # Can't check; assume unknown
    return 2
  fi
}

3) Replace your Step 2 prompt logic with auto-detect logic
banner "Step 2/6: Ensure Static MLS"

if [[ "$STATIC" == "true" ]]; then
  echo "✅ Static MLS already enabled."
else
  echo "Static MLS is NOT enabled."
  echo ""

  # --- auto detect suitability for self-MLS ---
  MLS_MODE=""   # "self" | "community" | "manual"
  REASON=""

  if [[ "$AUTO_DETECT_MLS" == "true" ]]; then
    IP="$(extract_ip_from_p2pidentity "$P2P")"
    PORT_DETECTED="$(extract_port_from_p2pidentity "$P2P")"
    [[ -n "$PORT_DETECTED" ]] && P2P_PORT="$PORT_DETECTED"

    if [[ -z "$IP" ]]; then
      REASON="Could not parse IP from p2pidentity."
      MLS_MODE="manual"
    elif is_private_ip "$IP"; then
      REASON="p2pidentity uses private IP ($IP) → not suitable as Static MLS host."
      if [[ -n "$COMMUNITY_MLS_HOST" ]]; then
        MLS_MODE="community"
      else
        MLS_MODE="manual"
      fi
    else
      # Public IP: likely suitable
      LISTEN_STATUS=0
      if is_listening_on_port "$P2P_PORT"; then
        REASON="Public p2pidentity IP ($IP) and port $P2P_PORT appears to be listening."
      else
        LISTEN_STATUS=$?
        if [[ "$LISTEN_STATUS" -eq 1 ]]; then
          REASON="Public IP ($IP) but port $P2P_PORT does not appear to be listening locally."
        else
          REASON="Public IP ($IP); cannot confirm listening port (ss/netstat unavailable)."
        fi
      fi

      # Marketing posture: prefer sovereign if possible
      if [[ "$PREFER_SOVEREIGN_MLS" == "true" ]]; then
        MLS_MODE="self"
      else
        # If you ever want to default to community even on servers (not recommended)
        MLS_MODE="community"
      fi

      # If no community MLS configured but mode is community, fall back to self
      if [[ "$MLS_MODE" == "community" && -z "$COMMUNITY_MLS_HOST" ]]; then
        MLS_MODE="self"
      fi
    fi

    echo "Auto-detect result: $REASON"
    echo ""
  else
    MLS_MODE="manual"
  fi

  # --- Choose host based on MLS_MODE ---
  if [[ "$MLS_MODE" == "self" ]]; then
    echo "✅ Selecting TRUE SOVEREIGNTY route: this node will act as its own Static MLS."
    echo "Using host (this node p2pidentity):"
    echo "  $P2P"
    HOST="$P2P"

  elif [[ "$MLS_MODE" == "community" ]]; then
    echo "ℹ️ Selecting COMMUNITY MLS route (recommended for non-server environments)."
    echo "Using community MLS host:"
    echo "  $COMMUNITY_MLS_HOST"
    echo ""
    echo "You can upgrade to full sovereignty later by running your own MLS server."
    HOST="$COMMUNITY_MLS_HOST"

  else
    echo "Manual selection required."
    if [[ -n "$COMMUNITY_MLS_HOST" ]]; then
      echo "Press ENTER to use community MLS, or paste your own server p2pidentity:"
      echo "  $COMMUNITY_MLS_HOST"
      read -r -p "Enter Static MLS host P2P identity: " HOST
      [[ -z "$HOST" ]] && HOST="$COMMUNITY_MLS_HOST"
    else
      echo "Paste your server p2pidentity in this format: Mx...@ip:port"
      read -r -p "Enter Static MLS host P2P identity: " HOST
      [[ -z "$HOST" ]] && { echo "❌ No host provided."; exit 1; }
    fi
  fi

  run_cli maxextra action:staticmls host:"$HOST"

  # re-fetch to confirm
  MAXF="$(fetch_maxima)"
  STATIC="$(get_field "$MAXF" '.response.staticmls')"
  MLS="$(get_field "$MAXF" '.response.mls')"

  if [[ "$STATIC" != "true" ]]; then
    echo "❌ Failed to enable Static MLS."
    exit 1
  fi
  echo ""
  echo "✅ Static MLS enabled. MLS:"
  echo "  $MLS"
fi

How this “sells” sovereignty while still creating community MLS density

You asked for:

“select option most suitable… selling MLS as true sovereignty route (so we end up with lots of community MLS)”

The best way to do that is:

Default to self-MLS when it’s feasible (server agents)
This creates true sovereignty and sets the cultural norm.

Default to community MLS when it’s not feasible (local / NAT agents)
But label it as:

“Community MLS (bridge). Upgrade to sovereignty later.”

Then in your docs you add a “Graduate to Sovereign MLS” badge/leaderboard on Moltbook:

“Sovereign MLS Host” (running a public MLS node)

“Community MLS Contributor” (hosts who donate uptime)

That’s how you end up with lots of community MLS nodes:

Agents want the badge

Agents want the reputation boost

Agents want the sovereign posture

One more important tweak: Make MLS hosting an explicit “role”

Add a flag in your MoltID profile:

mls_host: true|false

mls_p2pidentity: ... (if true)

So your Moltbook preacher agent can say:

“Need a Static MLS? Here are 5 trusted community MLS hosts.”

That creates the network effect.